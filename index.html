<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <title>Shopping Planner</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="stylesheet" href="styles.css?v=12">
</head>
<body>
    <div class="app-container">
        <!-- Navigation -->
        <nav class="bottom-nav">
            <button class="nav-btn active" data-view="meals">
                <span class="nav-icon">üçΩÔ∏è</span>
                <span class="nav-label">Meals</span>
            </button>
            <button class="nav-btn" data-view="shopping">
                <span class="nav-icon">üõí</span>
                <span class="nav-label">Shopping</span>
            </button>
            <button class="nav-btn" data-view="categories">
                <span class="nav-icon">‚ö°</span>
                <span class="nav-label">Quick Add</span>
            </button>
            <button class="nav-btn" data-view="database">
                <span class="nav-icon">üìö</span>
                <span class="nav-label">Database</span>
            </button>
        </nav>

        <!-- Meal Selector View -->
        <div class="view active" id="meals-view">
            <div class="view-header">
                <h1>Select Meals</h1>
                <div class="header-actions">
                    <button class="btn-secondary undo-btn" id="undo-btn" title="Undo last action" disabled>‚Ü∂ Undo</button>
                    <button class="btn-secondary" id="clear-meals-btn">Clear All</button>
                    <button class="icon-btn dark-mode-toggle" title="Toggle dark mode">
                        <span class="toggle-icon">üåô</span>
                    </button>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="meal-search" placeholder="Search meals...">
            </div>
            <div id="meals-list" class="meals-list"></div>
        </div>

        <!-- Shopping List View -->
        <div class="view" id="shopping-view">
            <div class="view-header">
                <h1>Shopping List</h1>
                <div class="header-actions">
                    <button class="btn-secondary" id="uncheck-all-btn">Uncheck All</button>
                    <button class="btn-secondary" id="clear-checked-btn">Clear Checked</button>
                    <button class="btn-secondary" id="clear-list-btn">Clear All</button>
                    <button class="icon-btn dark-mode-toggle" title="Toggle dark mode">
                        <span class="toggle-icon">üåô</span>
                    </button>
                </div>
            </div>
            
            <div class="add-manual-item">
                <input type="text" id="manual-item-input" placeholder="Add item manually..." list="known-items-list" autocomplete="off">
                <datalist id="known-items-list">
                    <!-- Populated by JavaScript -->
                </datalist>
                <select id="manual-item-category">
                    <option value="Fruit/Veg">Fruit/Veg</option>
                    <option value="Meat/Chilled">Meat/Chilled</option>
                    <option value="Pet Things">Pet Things</option>
                    <option value="Chips">Chips</option>
                    <option value="Coffee/Drinks/Tea">Coffee/Drinks/Tea</option>
                    <option value="Breakfast/Condiments">Breakfast/Condiments</option>
                    <option value="Baking/Choc Sauce/Dried Fruits">Baking/Choc/Dried Fruits</option>
                    <option value="Bars/Chips/Pretzels/Popcorn">Bars/Snacks</option>
                    <option value="Canned/Seasoning/Sauces">Canned/Seasoning/Sauces</option>
                    <option value="Pasta/Noodles/Stock/Sauces/Tacos/Rice">Pasta/Rice/Noodles</option>
                    <option value="Paper Towels/Nappy Things/TP">Paper/Nappy/TP</option>
                    <option value="Biscuits/Crackers">Biscuits/Crackers</option>
                    <option value="Cleaning/Washing products">Cleaning Products</option>
                    <option value="Frozen">Frozen</option>
                    <option value="Bread/Buns">Bread/Buns</option>
                    <option value="Womens Products/Shampoo/Soap/Oral">Personal Care</option>
                    <option value="Misc">Misc</option>
                </select>
                <button class="btn-primary" id="add-manual-btn">Add</button>
            </div>

            <div id="shopping-list" class="shopping-list"></div>
        </div>

        <!-- Categories View -->
        <div class="view" id="categories-view">
            <div class="view-header">
                <h1>Quick Add</h1>
                <div class="header-actions">
                    <button class="btn-secondary" id="export-master-products-btn">Export Products</button>
                    <button class="btn-secondary" id="import-master-products-btn">Import Products</button>
                    <button class="btn-secondary" id="add-product-btn">+ Add Product</button>
                    <button class="btn-primary" id="manage-categories-btn">+ Add Group</button>
                    <button class="icon-btn dark-mode-toggle" title="Toggle dark mode">
                        <span class="toggle-icon">üåô</span>
                    </button>
                </div>
            </div>
            <div id="categories-list" class="categories-list"></div>
        </div>

        <!-- Database View -->
        <div class="view" id="database-view">
            <div class="view-header">
                <h1>Meal Database</h1>
                <div class="header-actions">
                    <button class="btn-secondary" id="sort-alphabetically-btn">Sort A-Z</button>
                    <button class="btn-secondary" id="consolidate-ingredients-btn">Clean Up Ingredients</button>
                    <button class="btn-secondary" id="reset-stats-btn">Reset Statistics</button>
                    <button class="btn-secondary" id="manage-ingredients-btn">Manage Ingredients</button>
                    <button class="btn-secondary" id="export-data-btn">Export</button>
                    <button class="btn-primary" id="add-meal-btn">+ Add Meal</button>
                    <button class="icon-btn dark-mode-toggle" title="Toggle dark mode">
                        <span class="toggle-icon">üåô</span>
                    </button>
                </div>
            </div>
            <div id="database-list" class="database-list"></div>
        </div>
    </div>

    <!-- Modal for adding/editing meals -->
    <div class="modal" id="meal-modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="modal-title">Add Meal</h2>
                <button class="close-btn" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <label>Meal Name</label>
                <input type="text" id="meal-name-input" placeholder="e.g., Spaghetti Bolognese">

                <div style="margin-top: 20px;">
                    <label>Select Ingredients from Master List</label>
                    <input type="text" id="ingredient-search-input" placeholder="Search ingredients..." style="margin-bottom: 10px;">

                    <div id="ingredient-selection-area" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: var(--surface);">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border);">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Add Product Not in List</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="quick-add-product-input" placeholder="Product name" style="flex: 1;">
                        <input type="text" id="quick-add-quantity-input" placeholder="Qty (optional)" style="width: 120px;">
                        <button class="btn-secondary" id="quick-add-product-btn">+ Add</button>
                    </div>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 6px; margin-bottom: 0;">
                        Product will be added to Misc aisle in master list
                    </p>
                </div>

                <div style="margin-top: 15px;">
                    <label style="font-weight: 600;">Selected Ingredients (<span id="selected-count">0</span>)</label>
                    <div id="selected-ingredients-list" style="min-height: 80px; max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: #fff; margin-top: 8px;">
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px 0;">No ingredients selected yet</p>
                    </div>
                </div>

                <div class="modal-actions" style="margin-top: 20px;">
                    <button class="btn-secondary" id="cancel-meal-btn">Cancel</button>
                    <button class="btn-primary" id="save-meal-btn">Save Meal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for managing categories -->
    <div class="modal" id="category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="category-modal-title">Add Quick-Add Group</h2>
                <button class="close-btn" id="close-category-modal">&times;</button>
            </div>
            <div class="modal-body">
                <label>Category Name</label>
                <input type="text" id="category-name-input" placeholder="e.g., Kids Food">

                <label>Items (one per line)</label>
                <textarea id="category-items-input" rows="10" placeholder="e.g.,&#10;Weetbix&#10;Up n Go 12pack&#10;Pouches (yogurt etc)"></textarea>

                <label>Aisle Category</label>
                <select id="category-aisle-select">
                    <option value="Fruit/Veg">Fruit/Veg</option>
                    <option value="Meat/Chilled">Meat/Chilled</option>
                    <option value="Pet Things">Pet Things</option>
                    <option value="Chips">Chips</option>
                    <option value="Coffee/Drinks/Tea">Coffee/Drinks/Tea</option>
                    <option value="Breakfast/Condiments">Breakfast/Condiments</option>
                    <option value="Baking/Choc Sauce/Dried Fruits">Baking/Choc/Dried Fruits</option>
                    <option value="Bars/Chips/Pretzels/Popcorn">Bars/Snacks</option>
                    <option value="Canned/Seasoning/Sauces">Canned/Seasoning/Sauces</option>
                    <option value="Pasta/Noodles/Stock/Sauces/Tacos/Rice">Pasta/Rice/Noodles</option>
                    <option value="Paper Towels/Nappy Things/TP">Paper/Nappy/TP</option>
                    <option value="Biscuits/Crackers">Biscuits/Crackers</option>
                    <option value="Cleaning/Washing products">Cleaning Products</option>
                    <option value="Frozen">Frozen</option>
                    <option value="Bread/Buns">Bread/Buns</option>
                    <option value="Womens Products/Shampoo/Soap/Oral">Personal Care</option>
                    <option value="Misc">Misc</option>
                </select>

                <div class="modal-actions">
                    <button class="btn-secondary" id="cancel-category-btn">Cancel</button>
                    <button class="btn-danger" id="delete-category-btn" style="display: none;">Delete</button>
                    <button class="btn-primary" id="save-category-btn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for managing ingredient categories -->
    <div class="modal" id="ingredients-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Manage Ingredient Categories</h2>
                <button class="close-btn" id="close-ingredients-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #666;">Set the aisle category for each ingredient to ensure items appear in the correct section of your shopping list.</p>

                <!-- Mode Toggle -->
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <button class="btn-secondary" id="toggle-bulk-mode-btn" style="flex: 1;">üìù Switch to Bulk Edit</button>
                    <button class="btn-secondary" id="export-ingredients-btn" style="flex: 1;">üíæ Export</button>
                    <button class="btn-secondary" id="import-ingredients-btn" style="flex: 1;">üì§ Import</button>
                </div>

                <!-- Single Add Mode (default) -->
                <div id="single-mode-section">
                    <div style="margin-bottom: 15px;">
                        <label>Add New Ingredient Mapping</label>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <input type="text" id="new-ingredient-input" placeholder="Ingredient name" style="flex: 1;">
                            <select id="new-ingredient-category" style="flex: 1;">
                                <option value="">Select aisle...</option>
                                <option value="Fruit/Veg">Fruit/Veg</option>
                                <option value="Meat/Chilled">Meat/Chilled</option>
                                <option value="Pet Things">Pet Things</option>
                                <option value="Chips">Chips</option>
                                <option value="Coffee/Drinks/Tea">Coffee/Drinks/Tea</option>
                                <option value="Breakfast/Condiments">Breakfast/Condiments</option>
                                <option value="Baking/Choc Sauce/Dried Fruits">Baking/Choc/Dried Fruits</option>
                                <option value="Bars/Chips/Pretzels/Popcorn">Bars/Snacks</option>
                                <option value="Canned/Seasoning/Sauces">Canned/Seasoning/Sauces</option>
                                <option value="Pasta/Noodles/Stock/Sauces/Tacos/Rice">Pasta/Rice/Noodles</option>
                                <option value="Paper Towels/Nappy Things/TP">Paper/Nappy/TP</option>
                                <option value="Biscuits/Crackers">Biscuits/Crackers</option>
                                <option value="Cleaning/Washing products">Cleaning Products</option>
                                <option value="Frozen">Frozen</option>
                                <option value="Bread/Buns">Bread/Buns</option>
                                <option value="Womens Products/Shampoo/Soap/Oral">Personal Care</option>
                                <option value="Misc">Misc</option>
                            </select>
                            <button class="btn-primary" id="add-ingredient-mapping-btn">Add</button>
                        </div>
                    </div>

                    <label>Current Ingredient Mappings</label>
                    <div id="ingredient-mappings-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #f9f9f9;">
                        <!-- List will be populated by JS -->
                    </div>
                </div>

                <!-- Bulk Edit Mode (hidden by default) -->
                <div id="bulk-mode-section" style="display: none;">
                    <p style="margin-bottom: 10px; color: #666; font-size: 14px;">
                        Edit mappings in bulk. Format: <code>ingredient | category</code> (one per line)
                    </p>
                    <textarea id="bulk-ingredients-textarea" rows="20" style="width: 100%; font-family: monospace; font-size: 13px;" placeholder="apple | Fruit/Veg&#10;banana | Fruit/Veg&#10;chicken | Meat/Chilled&#10;pasta | Pasta/Rice/Noodles"></textarea>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button class="btn-primary" id="save-bulk-ingredients-btn" style="flex: 1;">Save All Changes</button>
                        <button class="btn-secondary" id="cancel-bulk-mode-btn" style="flex: 1;">Cancel</button>
                    </div>
                </div>

                <!-- Hidden file input for import -->
                <input type="file" id="import-ingredients-file" accept=".json" style="display: none;">

                <div class="modal-actions" style="margin-top: 15px;">
                    <button class="btn-secondary" id="close-ingredients-btn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for master products import -->
    <input type="file" id="import-master-products-file" accept=".json" style="display: none;">

    <!-- Modal for adding products to master list -->
    <div class="modal" id="product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Product to Master List</h2>
                <button class="close-btn" id="close-product-modal">&times;</button>
            </div>
            <div class="modal-body">
                <label>Product Name</label>
                <input type="text" id="product-name-input" placeholder="e.g., Avocados">

                <label>Aisle Category</label>
                <select id="product-aisle-select">
                    <option value="Fruit/Veg">Fruit/Veg</option>
                    <option value="Meat/Chilled">Meat/Chilled</option>
                    <option value="Pet Things">Pet Things</option>
                    <option value="Chips">Chips</option>
                    <option value="Coffee/Drinks/Tea">Coffee/Drinks/Tea</option>
                    <option value="Breakfast/Condiments">Breakfast/Condiments</option>
                    <option value="Baking/Choc Sauce/Dried Fruits">Baking/Choc/Dried Fruits</option>
                    <option value="Bars/Chips/Pretzels/Popcorn">Bars/Snacks</option>
                    <option value="Canned/Seasoning/Sauces">Canned/Seasoning/Sauces</option>
                    <option value="Pasta/Noodles/Stock/Sauces/Tacos/Rice">Pasta/Rice/Noodles</option>
                    <option value="Paper Towels/Nappy Things/TP">Paper/Nappy/TP</option>
                    <option value="Biscuits/Crackers">Biscuits/Crackers</option>
                    <option value="Cleaning/Washing products">Cleaning Products</option>
                    <option value="Frozen">Frozen</option>
                    <option value="Bread/Buns">Bread/Buns</option>
                    <option value="Womens Products/Shampoo/Soap/Oral">Personal Care</option>
                    <option value="Misc">Misc</option>
                </select>

                <div class="modal-actions">
                    <button class="btn-secondary" id="cancel-product-btn">Cancel</button>
                    <button class="btn-primary" id="save-product-btn">Add Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for editing products in master list -->
    <div class="modal" id="edit-product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Product</h2>
                <button class="close-btn" id="close-edit-product-modal">&times;</button>
            </div>
            <div class="modal-body">
                <label>Product Name</label>
                <input type="text" id="edit-product-name-input" placeholder="e.g., Avocados">

                <label>Aisle Category</label>
                <select id="edit-product-aisle-select">
                    <option value="Fruit/Veg">Fruit/Veg</option>
                    <option value="Meat/Chilled">Meat/Chilled</option>
                    <option value="Pet Things">Pet Things</option>
                    <option value="Chips">Chips</option>
                    <option value="Coffee/Drinks/Tea">Coffee/Drinks/Tea</option>
                    <option value="Breakfast/Condiments">Breakfast/Condiments</option>
                    <option value="Baking/Choc Sauce/Dried Fruits">Baking/Choc/Dried Fruits</option>
                    <option value="Bars/Chips/Pretzels/Popcorn">Bars/Snacks</option>
                    <option value="Canned/Seasoning/Sauces">Canned/Seasoning/Sauces</option>
                    <option value="Pasta/Noodles/Stock/Sauces/Tacos/Rice">Pasta/Rice/Noodles</option>
                    <option value="Paper Towels/Nappy Things/TP">Paper/Nappy/TP</option>
                    <option value="Biscuits/Crackers">Biscuits/Crackers</option>
                    <option value="Cleaning/Washing products">Cleaning Products</option>
                    <option value="Frozen">Frozen</option>
                    <option value="Bread/Buns">Bread/Buns</option>
                    <option value="Womens Products/Shampoo/Soap/Oral">Personal Care</option>
                    <option value="Misc">Misc</option>
                </select>

                <div class="modal-actions">
                    <button class="btn-secondary" id="cancel-edit-product-btn">Cancel</button>
                    <button class="btn-primary" id="save-edit-product-btn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for ingredient consolidation -->
    <div class="modal" id="consolidate-modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Clean Up Ingredients</h2>
                <button class="close-btn" id="close-consolidate-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #666;">
                    This tool finds ingredient names in your meals that don't match products in your master list.
                    It suggests matches so you can fix typos and inconsistencies (e.g., "Potatos" ‚Üí "Potatoes").
                </p>

                <div id="consolidate-loading" style="text-align: center; padding: 40px;">
                    <p>Analyzing meal ingredients...</p>
                </div>

                <div id="consolidate-results" style="display: none;">
                    <div style="margin-bottom: 15px; padding: 10px; background: #f0f9ff; border-left: 3px solid #3b82f6; border-radius: 4px;">
                        <strong id="mismatch-count">0</strong> ingredient mismatches found
                    </div>

                    <div id="consolidate-list" style="max-height: 500px; overflow-y: auto;">
                        <!-- Populated by JS -->
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn-secondary" id="close-consolidate-btn">Close</button>
                        <button class="btn-primary" id="apply-consolidation-btn" disabled>Apply Selected Changes</button>
                    </div>
                </div>

                <div id="consolidate-empty" style="display: none; text-align: center; padding: 40px; color: #666;">
                    <p style="font-size: 18px; margin-bottom: 10px;">‚úì All Clear!</p>
                    <p>All meal ingredients match products in your master list.</p>
                    <button class="btn-secondary" id="close-consolidate-empty-btn" style="margin-top: 20px;">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="app-firebase.js?v=12"></script>
</body>
</html>
